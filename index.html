<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Школьное расписание</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Школьное расписание</h1>
    </header>

    <main>
        <div class="class-buttons">
            <!-- Все классы -->
            <button class="class-button" onclick="loadSchedule('5а')">5а</button>
            <button class="class-button" onclick="loadSchedule('5б')">5б</button>
            <button class="class-button" onclick="loadSchedule('5в')">5в</button>
            <button class="class-button" onclick="loadSchedule('5г')">5г</button>
            <button class="class-button" onclick="loadSchedule('6а')">6а</button>
            <button class="class-button" onclick="loadSchedule('6б')">6б</button>
            <button class="class-button" onclick="loadSchedule('6в')">6в</button>
            <button class="class-button" onclick="loadSchedule('6г')">6г</button>
            <button class="class-button" onclick="loadSchedule('7а')">7а</button>
            <button class="class-button" onclick="loadSchedule('7б')">7б</button>
            <button class="class-button" onclick="loadSchedule('7в')">7в</button>
            <button class="class-button" onclick="loadSchedule('7г')">7г</button>
            <button class="class-button" onclick="loadSchedule('8а')">8а</button>
            <button class="class-button" onclick="loadSchedule('8б')">8б</button>
            <button class="class-button" onclick="loadSchedule('8в')">8в</button>
            <button class="class-button" onclick="loadSchedule('9а')">9а</button>
            <button class="class-button" onclick="loadSchedule('9б')">9б</button>
            <button class="class-button" onclick="loadSchedule('9в')">9в</button>
            <button class="class-button" onclick="loadSchedule('9г')">9г</button>
            <button class="class-button" onclick="loadSchedule('9д')">9д</button>
            <button class="class-button" onclick="loadSchedule('10ен')">10ен</button>
            <button class="class-button" onclick="loadSchedule('10тех')">10тех</button>
            <button class="class-button" onclick="loadSchedule('10б')">10б</button>
            <button class="class-button" onclick="loadSchedule('11ен')">11ен</button>
            <button class="class-button" onclick="loadSchedule('11тех')">11тех</button>
            <button class="class-button" onclick="loadSchedule('11б')">11б</button>
        </div>

        <div class="schedule-container" id="scheduleTableContainer" style="display: none">
            <h2 id="classTitle"></h2>
            <table id="scheduleTable">
                <thead>
                    <tr>
                        <th>№ Урока</th>
                        <th>Предмет</th>
                        <th>Учитель</th>
                        <th>Время начала</th>
                    </tr>
                </thead>
                <tbody id="scheduleBody"></tbody>
            </table>
        </div>

        <h2>Введите расписание под паролем</h2>
        <form id="passwordForm">
            <input type="password" id="password" placeholder="Введите пароль" required>
            <button type="submit">Подтвердить</button>
        </form>

        <form id="scheduleForm" style="display: none;">
            <div class="form-control">
                <label for="className">Выберите класс:</label>
                <select id="className">
                    <option value="5а">5а</option>
                    <option value="5б">5б</option>
                    <option value="5в">5в</option>
                    <option value="5г">5г</option>
                    <option value="6а">6а</option>
                    <option value="6б">6б</option>
                    <option value="6в">6в</option>
                    <option value="6г">6г</option>
                    <option value="7а">7а</option>
                    <option value="7б">7б</option>
                    <option value="7в">7в</option>
                    <option value="7г">7г</option>
                    <option value="8а">8а</option>
                    <option value="8б">8б</option>
                    <option value="8в">8в</option>
                    <option value="9а">9а</option>
                    <option value="9б">9б</option>
                    <option value="9в">9в</option>
                    <option value="9г">9г</option>
                    <option value="9д">9д</option>
                    <option value="10ен">10ен</option>
                    <option value="10тех">10тех</option>
                    <option value="10б">10б</option>
                    <option value="11ен">11ен</option>
                    <option value="11тех">11тех</option>
                    <option value="11б">11б</option>
                </select>
            </div>

            <div class="form-control">
                <label for="teacher">Выберите учителя:</label>
                <select id="teacher">
                    <option value="Иванова И.И.">Иванова И.И.</option>
                    <option value="Петров П.П.">Петров П.П.</option>
                    <option value="Сидорова С.С.">Сидорова С.С.</option>
                </select>
            </div>

            <div class="form-control">
                <label for="lessonNumber">Выберите номер урока:</label>
                <select id="lessonNumber">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                </select>
            </div>

            <div class="form-control">
                <label for="subject">Введите предмет:</label>
                <input type="text" id="subject" placeholder="Математика, Русский и т.д." required>
            </div>

            <div class="form-control">
                <label for="absence">Если урока нет, выберите:</label>
                <select id="absence">
                    <option value="">Урок присутствует</option>
                    <option value="окно">Окно</option>
                </select>
            </div>

            <button type="submit">Сохранить расписание как CSV</button>
        </form>
    </main>

    <script>
        let passwordCorrect = false;

        document.getElementById('passwordForm').addEventListener('submit', function(event) {
            event.preventDefault();
            const password = document.getElementById('password').value;
            if (password === "3_School_Achinsk") {
                passwordCorrect = true;
                document.getElementById('scheduleForm').style.display = 'block';
                document.getElementById('passwordForm').style.display = 'none';
            } else {
                alert('Неверный пароль!');
            }
        });

        let schedules = {};

        async function loadSchedules() {
            const response = await fetch('https://gist.githubusercontent.com/3-School-Achinsk/4b7c67ffb92982bfebd3511f702756e3/raw/79bf1323d0336531e9fc5cd7db016078da34b85a/schedules.json');
            return await response.json();
        }

        loadSchedules().then(data => {
            schedules = data;
        });

        document.getElementById('scheduleForm').addEventListener('submit', function(event) {
            event.preventDefault();
            if (!passwordCorrect) return; // Проверка пароля

            const className = document.getElementById('className').value;
            const subject = document.getElementById('subject').value;
            const lessonNumber = document.getElementById('lessonNumber').value;
            const teacher = document.getElementById('teacher').value;
            const absence = document.getElementById('absence').value;

            // Обновление расписания
            if (absence === "окно") {
                schedules[className] = schedules[className] || [];
                schedules[className][lessonNumber - 1] = `${lessonNumber} Окно`;
            } else {
                const lessonEntry = `${lessonNumber} ${subject}, ${teacher}`;
                schedules[className] = schedules[className] || [];
                schedules[className][lessonNumber - 1] = lessonEntry;
            }

            // Генерация CSV
            const csvContent = "data:text/csv;charset=utf-8," + generateCSV(schedules[className]);
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${className}_schedule.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            alert('Расписание сохранено как CSV!');
            document.getElementById('scheduleForm').reset();
        });

        function loadSchedule(className) {
            const schedule = schedules[className];
            const scheduleBody = document.getElementById('scheduleBody');
            scheduleBody.innerHTML = ''; // Очищаем предыдущие данные

            if (schedule) {
                schedule.forEach(entry => {
                    if (entry) {
                        const [lessonNumber, subject, teacher] = entry.split(', ');
                        const startTime = getLessonStartTime(lessonNumber);
                        const row = `<tr>
                            <td>${lessonNumber}</td>
                            <td>${subject}</td>
                            <td>${teacher}</td>
                            <td>${startTime}</td>
                        </tr>`;
                        scheduleBody.insertAdjacentHTML('beforeend', row);
                    }
                });
            }

            document.getElementById('classTitle').innerText = `Расписание для класса ${className}`;
            document.getElementById('scheduleTableContainer').style.display = 'block';
        }

        function getLessonStartTime(lessonNumber) {
            const lessonTimes = {
                '1': '08:00',  // +4 часа
                '2': '08:50',
                '3': '09:40',
                '4': '10:40',
                '5': '11:40',
                '6': '12:30',
                '7': '17:20'
            };
            return lessonTimes[lessonNumber] || 'Неизвестно';
        }

        function generateCSV(data) {
            const csvRows = [];
            csvRows.push(['№ Урока', 'Предмет', 'Учитель', 'Время начала']); // Заголовки
            data.forEach(entry => {
                if (entry) {
                    const [lessonNumber, subject, teacher] = entry.split(', ');
                    const startTime = getLessonStartTime(lessonNumber);
                    csvRows.push([lessonNumber, subject, teacher, startTime]);
                }
            });
            return csvRows.map(row => row.join(",")).join("\n");
        }
    </script>
</body>
</html>
